## **1.  LangChainæ¡†æ¶æ ¸å¿ƒæ¨¡å—**

### 1.1 ç›¸å…³æ¦‚å¿µ

###    **ï¼ˆ1ï¼‰LangChainæ¡†æ¶ç®€ä»‹**  

LangChainæ˜¯ä¸€ä¸ªAIåº”ç”¨ç¨‹åºå¼€å‘æ¡†æ¶ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹æ„å»ºç«¯åˆ°ç«¯çš„åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€å¥—å·¥å…·ã€ç»„ä»¶å’Œæ¥å£ï¼Œå¯ç®€åŒ–åˆ›å»ºç”±å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å’ŒèŠå¤©æ¨¡å‹æä¾›æ”¯æŒçš„åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ã€‚LangChainå¯ä»¥è½»æ¾ç®¡ç†ä¸è¯­è¨€æ¨¡å‹çš„äº¤äº’ï¼Œå°†å¤šä¸ªç»„ä»¶é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶é›†æˆé¢å¤–çš„èµ„æºï¼Œä¾‹å¦‚APIå’Œæ•°æ®åº“ã€‚

**LangChainçš„ä¸»è¦ä»·å€¼åœ¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š**

- ç»„ä»¶åŒ–ï¼šLangChain æ¡†æ¶æä¾›äº†ç”¨äºå¤„ç†å¤§è¯­è¨€æ¨¡å‹çš„æŠ½è±¡ç»„ä»¶ï¼Œä»¥åŠæ¯ä¸ªæŠ½è±¡ç»„ä»¶çš„ä¸€ç³»åˆ—å®ç°ã€‚è¿™äº›ç»„ä»¶å…·æœ‰æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºä½¿ç”¨ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ LangChain æ¡†æ¶çš„å…¶ä»–éƒ¨åˆ†ï¼Œéƒ½å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨è¿™äº›ç»„ä»¶ã€‚
- ç®€åŒ–å¼€å‘éš¾åº¦ï¼šé€šè¿‡æä¾›ç»„ä»¶åŒ–å’Œç°æˆçš„é“¾å¼ç»„è£…ï¼ŒLangChain æ¡†æ¶å¯ä»¥å¤§å¤§ç®€åŒ–å¤§è¯­è¨€æ¨¡å‹åº”ç”¨çš„å¼€å‘éš¾åº¦ã€‚å¼€å‘äººå‘˜å¯ä»¥æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ— éœ€èŠ±è´¹å¤§é‡æ—¶é—´å’Œç²¾åŠ›å¤„ç†åº•å±‚æŠ€æœ¯ç»†èŠ‚ã€‚

#### **ï¼ˆ2ï¼‰LangChainæ¡†æ¶çš„ç»„æˆéƒ¨åˆ†**

LangChainæ¡†æ¶ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

- **LangChain åº“**ï¼šPython å’Œ JavaScript åº“ã€‚åŒ…å«å¤§é‡ç»„ä»¶çš„æ¥å£å’Œé›†æˆï¼Œå°†è¿™äº›ç»„ä»¶ç»„åˆæˆé“¾å’Œä»£ç†çš„åŸºæœ¬è¿è¡Œæ—¶ï¼Œä»¥åŠé“¾å’Œä»£ç†çš„ç°æˆå®ç°ã€‚
- **LangChain Template**ï¼šä¸€ç³»åˆ—æ˜“äºéƒ¨ç½²çš„å‚è€ƒæ¶æ„ï¼Œç”¨äºå„ç§ä»»åŠ¡ã€‚
- **LangServe**ï¼šä¸€ä¸ªç”¨äºå°† LangChain é“¾éƒ¨ç½²ä¸º REST API çš„åº“ã€‚
- **LangSmith**ï¼šä¸€ä¸ªå¼€å‘è€…å¹³å°ï¼Œè®©ä½ å¯ä»¥è°ƒè¯•ã€æµ‹è¯•ã€è¯„ä¼°å’Œç›‘æ§åŸºäºä»»ä½• LLM æ¡†æ¶æ„å»ºçš„é“¾ï¼Œå¹¶ä¸”ä¸ LangChain æ— ç¼é›†æˆã€‚

   


LangChain åº“ç”±ä»¥ä¸‹å‡ ä¸ªåŒ…ç»„æˆï¼š

- **langchain-coreï¼š**åŸºç¡€æŠ½è±¡å’Œ LangChainè¡¨è¾¾å¼è¯­è¨€ã€‚
- **langchain-communityï¼š**ç¬¬ä¸‰æ–¹é›†æˆã€‚
- **langchain**ï¼šæ„æˆåº”ç”¨ç¨‹åºè®¤çŸ¥æ¶æ„çš„Chainã€Agentå’ŒRAGæ£€ç´¢ç­–ç•¥ã€‚

![596267428b6d6ef3057389e489953d0d](img/å®éªŒæ‰‹å†Œ/596267428b6d6ef3057389e489953d0d.svg)

####    **ï¼ˆ3ï¼‰LangChainçš„æ ¸å¿ƒæ¨¡å—**

**LangChainæä¾›ä»¥ä¸‹å…­ç§æ ‡å‡†çš„ã€å¯æ‰©å±•çš„æ¥å£å’Œå¤–éƒ¨é›†æˆçš„æ ¸å¿ƒæ¨¡å—ï¼š**

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240506%2Fac1d8d7497f44729965a4b88e6aa8be0.jpg)

- **æ¨¡å‹I/Oï¼ˆModel I/Oï¼‰ï¼š**è´Ÿè´£ä¸è¯­è¨€æ¨¡å‹è¿›è¡Œäº¤äº’ï¼Œå¤„ç†è¾“å…¥å’Œè¾“å‡ºæ•°æ®ã€‚
- **æ£€ç´¢ï¼ˆRetrievalï¼‰ï¼š**ä»ç‰¹å®šæ•°æ®æºæ£€ç´¢ä¿¡æ¯ï¼Œå¦‚æ•°æ®åº“æˆ–APIï¼Œä¸ºåº”ç”¨æä¾›æ‰€éœ€å†…å®¹ã€‚
- **ä»£ç†ï¼ˆAgentsï¼‰ï¼š**æ ¹æ®é«˜çº§æŒ‡ä»¤å†³å®šä½¿ç”¨å“ªäº›å·¥å…·æˆ–ç»„ä»¶ï¼Œåè°ƒåº”ç”¨å†…çš„æ“ä½œå’Œä¿¡æ¯æµã€‚
- **é“¾ï¼ˆChainsï¼‰**ï¼šå®šä¹‰ä¸€ç³»åˆ—æœ‰åºæ­¥éª¤ä»¥å®Œæˆç‰¹å®šä»»åŠ¡ã€‚
- **å†…å­˜ï¼ˆMemoryï¼‰**ï¼šåœ¨LangChainè¿è¡Œé—´ä¿æŒåº”ç”¨çŠ¶æ€ã€‚
- **å›è°ƒï¼ˆCallbacksï¼‰**ï¼šåœ¨LangChainçš„ç‰¹å®šæ­¥éª¤è§¦å‘é¢å¤–åŠ¨ä½œï¼Œå¦‚æ—¥å¿—è®°å½•æˆ–ä¸­é—´æ­¥éª¤çš„æµå¼ä¼ è¾“ã€‚



### 1.2 å®è·µ3. **LangChainçš„æ ¸å¿ƒæ¨¡å—è¯¦ç»†ä»‹ç»**

#### **3.1** Model I/O

#####    **ï¼ˆ1ï¼‰åŸºæœ¬æ¦‚å¿µ**

   åœ¨LangChainä¸­ï¼Œæ¨¡å‹è¾“å…¥/è¾“å‡ºï¼ˆModel I/Oï¼‰æ˜¯æŒ‡ä¸LLMè¿›è¡Œäº¤äº’çš„ç»„ä»¶ï¼Œå®ƒæ˜¯å¤§è¯­è¨€æ¨¡å‹åº”ç”¨çš„æ ¸å¿ƒå…ƒç´ ã€‚è¯¥æ¨¡å—çš„åŸºæœ¬æµç¨‹å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹3ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

- **æ ¼å¼åŒ–ï¼ˆFormatï¼‰**ï¼šåŸå§‹æ•°æ®è¢«æ¸…æ´—ã€æ ‡è®°åŒ–ã€ç¼–ç ï¼Œå¹¶æ ¹æ®ç‰¹å®šä»»åŠ¡éœ€æ±‚æ„å»ºæç¤ºæ¨¡æ¿ï¼Œä»¥è½¬æ¢æˆé€‚åˆè¯­è¨€æ¨¡å‹å¤„ç†çš„æ ¼å¼ã€‚
- **é¢„æµ‹ï¼ˆPredictï¼‰**ï¼šæ ¼å¼åŒ–åçš„æ•°æ®è¢«ç›´æ¥é€å…¥è¯­è¨€æ¨¡å‹ï¼Œæ¨¡å‹åŸºäºå…¶å†…éƒ¨çŸ¥è¯†å’Œè®­ç»ƒæ•°æ®ç”Ÿæˆæ–‡æœ¬è¾“å‡ºã€‚
- **è§£æï¼ˆParseï¼‰**ï¼šè¯­è¨€æ¨¡å‹çš„æ–‡æœ¬è¾“å‡ºè¢«æå–ç‰¹å®šä¿¡æ¯ã€è½¬æ¢æˆä¸åŒæ•°æ®ç±»å‹ï¼Œå¹¶ç»è¿‡å¿…è¦çš„åå¤„ç†ï¼Œä»¥æ»¡è¶³ä¸‹æ¸¸ç»„ä»¶æˆ–åº”ç”¨ç¨‹åºçš„ç»“æ„åŒ–éœ€æ±‚ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240506%2Fddd0a491d0ff4f79911eb4819c755d21.png)

   Model I/Oçš„æ ¸å¿ƒç»„ä»¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åŒ…å«ç”¨äºæ¥æ”¶å’Œç”Ÿæˆæ–‡æœ¬çš„è¯­è¨€æ¨¡å‹ã€æŒ‡å¯¼è¾“å…¥æ ¼å¼çš„æç¤ºæ¨¡æ¿ã€ç­›é€‰è®­ç»ƒæ•°æ®çš„ç¤ºä¾‹é€‰æ‹©å™¨ã€è§£ææ¨¡å‹è¾“å‡ºçš„è¾“å‡ºè§£æå™¨ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240506%2Fd34c2e23b9564c40b6487f19fbb66f2f.png)

â‘  **è¯­è¨€æ¨¡å‹ (Language Models)**ï¼šæä¾›äº†ä¸å¤§è¯­è¨€æ¨¡å‹çš„æ¥å£ï¼Œä¸»è¦æœ‰ä¸¤ç§ç±»å‹æ¨¡å‹çš„æ¥å£ï¼š

- **LLMsï¼š**å¤§å‹è¯­è¨€æ¨¡å‹ï¼Œæ¥æ”¶æ–‡æœ¬å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›æ–‡æœ¬å­—ç¬¦ä¸²ã€‚OpenAIçš„GPT-3æ˜¯LLMå®ç°çš„ä¸€ä¸ªå®ä¾‹ã€‚
- **Chat Modelï¼š**èŠå¤©æ¨¡å‹ï¼Œæ˜¯è¯­è¨€æ¨¡å‹çš„ä¸€ç§å˜ä½“ã€‚æ¥å—Chat Messagesåˆ—è¡¨ä½œä¸ºè¾“å…¥å¹¶è¿”å›Chat Messageã€‚Chat Modelä¸“ä¸ºä¼šè¯äº¤äº’è®¾è®¡ã€‚ä¸ä¼ ç»Ÿçš„çº¯æ–‡æœ¬è¡¥å…¨æ¨¡å‹ç›¸æ¯”ï¼Œè¿™ä¸€æ¨¡å‹çš„APIé‡‡ç”¨äº†ä¸åŒçš„æ¥å£æ–¹å¼ï¼šå®ƒéœ€è¦ä¸€ä¸ªæ ‡æœ‰è¯´è¯è€…èº«ä»½çš„èŠå¤©æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥ï¼Œå¦‚â€œç³»ç»Ÿâ€ã€â€œAIâ€æˆ–â€œäººç±»â€ã€‚ä½œä¸ºå“åº”ï¼ŒChat Modelä¼šè¿”å›ä¸€ä¸ªæ ‡ä¸ºâ€œAIâ€çš„èŠå¤©æ¶ˆæ¯è¾“å‡ºã€‚GPT-4å’ŒAnthropic çš„ Claudeéƒ½å¯ä»¥é€šè¿‡ Chat Model è°ƒç”¨ã€‚



â‘¡ **æ¶ˆæ¯(Message)**


| æ ‡è¯†ç¬¦    | å¯¹åº”ç±»        | å®é™…å«ä¹‰           | ä½¿ç”¨åœºæ™¯               | ç¤ºä¾‹å†…å®¹                             |
| --------- | ------------- | ------------------ | ---------------------- | ------------------------------------ |
| human     | HumanMessage  | æ¥è‡ªäººç±»ç”¨æˆ·çš„æ¶ˆæ¯ | LangChain åŸç”Ÿæ¶ˆæ¯ç³»ç»Ÿ | "hi"                                 |
| user      | HumanMessage  | æ¥è‡ªäººç±»ç”¨æˆ·çš„æ¶ˆæ¯ | å…¼å®¹ OpenAI API çš„æ ¼å¼ |                                      |
| ai        | AIMessage     | AI ç”Ÿæˆçš„å›å¤      | LangChain åŸç”Ÿæ¶ˆæ¯ç³»ç»Ÿ | "Hello! ğŸ˜Š How can I help you today?" |
| assistant | AIMessage     | AI ç”Ÿæˆçš„å›å¤      | å…¼å®¹ OpenAI API çš„æ ¼å¼ |                                      |
| system    | SystemMessage | ç³»ç»Ÿçº§æŒ‡ä»¤         | ä¸¤ç§ç³»ç»Ÿé€šç”¨           | "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹"             |



â‘¢  **æç¤ºæ¨¡æ¿(Prompt Templates)ï¼š**

- **PromptTemplateï¼š**ç”¨äºç”Ÿæˆå­—ç¬¦ä¸²æç¤ºã€‚
- **ChatPromptTemplateï¼š**ç”¨äºç”ŸæˆèŠå¤©æ¶ˆæ¯åˆ—è¡¨çš„æç¤ºã€‚

**â‘£ ç¤ºä¾‹é€‰æ‹©å™¨ï¼ˆExample Selectorsï¼‰ï¼š**

- **è®­ç»ƒæ–°æ¨¡å‹ï¼š**Example Selectorsä»æ•°æ®é›†ä¸­ç­›é€‰ä»£è¡¨æ€§çš„ç¤ºä¾‹æ¥è®­ç»ƒæ–°æ¨¡å‹ï¼Œç¡®ä¿å…¶å­¦ä¹ é«˜è´¨é‡ã€å¤šæ ·åŒ–çš„æ•°æ®ï¼Œæå‡å­¦ä¹ æ•ˆæœå’Œæ³›åŒ–èƒ½åŠ›ã€‚
- **è°ƒä¼˜ç°æœ‰æ¨¡å‹ï¼š**åˆ©ç”¨Example Selectorsæä¾›çš„æ–°ç¤ºä¾‹ï¼Œå¯¹ç°æœ‰æ¨¡å‹è¿›è¡ŒæŒç»­è®­ç»ƒå’Œè°ƒä¼˜ï¼Œé€æ­¥æ”¹è¿›å…¶åœ¨ç‰¹å®šä»»åŠ¡ä¸Šçš„è¡¨ç°ï¼Œæé«˜å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚

**â‘¤ è¾“å‡ºè§£æå™¨ï¼ˆOutput Parsersï¼‰ï¼š**

- **Get format instructionsï¼š**è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«è¦æ±‚è¯­è¨€æ¨¡å‹åº”è¯¥è¿”å›ä»€ä¹ˆæ ¼å¼å†…å®¹çš„æç¤ºè¯ã€‚
- **Parseï¼š**å°†æ¨¡å‹è¿”å›çš„å†…å®¹ï¼Œè§£æä¸ºç›®æ ‡æ ¼å¼ã€‚

##### **ï¼ˆ2ï¼‰Model I/Oå®è·µ**

åœ¨model_io_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ï¼Œé¦–å…ˆä½¿ç”¨BaseChatOpenAIåˆ›å»ºä¸€ä¸ªèŠå¤©æ¨¡å‹ï¼ŒæŒ‡å®šæ¨¡å‹åç§°ä¸ºâ€œdeepseek-chatâ€ï¼›ç„¶ååˆ›å»ºæç¤ºè¯æ¨¡æ¿ï¼Œç»™å®šAIä¸€ä¸ªèº«ä»½ï¼Œå³è®¾ç½®Systemæç¤ºè¯ä¸ºâ€æ‚¨æ˜¯ä¸€åç²¾é€šå¤ä»£å…¸ç±çš„ä¸“å®¶ã€‚ã€‚ç”¨æˆ·æç¤ºè¯è®¾ç½®ä¸ºâ€è¯·ä¸ºæˆ‘æ¨èè¯¸å­ç™¾å®¶ä¸­å¿…è¯»çš„ç»å…¸ä¹¦ç±â€œã€‚Langchainä¼šè°ƒç”¨ChatPromptTemplate.from_messages()ç”ŸæˆèŠå¤©æ¶ˆæ¯åˆ—è¡¨çš„æç¤ºã€‚æœ€åï¼Œè¿”å›LLMå›ç­”çš„ç»“æœï¼Œ ä½¿ç”¨model.invoke(chat_test).contentè·å–LLMå›ç­”çš„æ–‡æœ¬ï¼Œå…¶ä¸­ï¼Œchat_testè¡¨ç¤ºç”¨æˆ·çš„æç¤ºè¯ã€‚

#### 3.2 **Chains**

**ï¼ˆ1ï¼‰ Chainsä»‹ç»**

â€‹	 **â‘  Chainsçš„åŸºæœ¬æ¦‚å¿µåŠä¼˜åŠ¿**

   è™½ç„¶ç‹¬ç«‹ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿåº”å¯¹ä¸€äº›ç®€å•ä»»åŠ¡ï¼Œä½†å¯¹äºæ›´åŠ å¤æ‚çš„éœ€æ±‚ï¼Œå¯èƒ½éœ€è¦å°†å¤šä¸ªå¤§è¯­è¨€æ¨¡å‹è¿›è¡Œé“¾å¼ç»„åˆï¼Œæˆ–ä¸å…¶ä»–ç»„ä»¶è¿›è¡Œé“¾å¼è°ƒç”¨ã€‚LangChainä¸ºè¿™ç§â€œé“¾å¼â€åº”ç”¨æä¾›äº†Chainæ¥å£ï¼Œå¹¶å°†è¯¥æ¥å£å®šä¹‰å¾—éå¸¸é€šç”¨ã€‚ä½œä¸ºä¸€ä¸ªè°ƒç”¨ç»„ä»¶å¾—åºåˆ—ï¼Œè¿˜å¯ä»¥åŒ…å«å…¶ä»–é“¾ã€‚Chainså…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **æ¨¡å—åŒ–ï¼š**æé«˜ä»£ç å¤ç”¨æ€§ï¼Œé™ä½å¼€å‘å¤æ‚æ€§ã€‚
- **å¯ç»´æŠ¤æ€§ï¼š**æ˜“äºç†è§£å’Œç»´æŠ¤ï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œæ‰©å±•ã€‚
- **çµæ´»æ€§ï¼š**æ”¯æŒä¸åŒç»„åˆæ–¹å¼ï¼Œé€‚åº”å¤šå˜éœ€æ±‚ã€‚


â€‹	â‘¡ **Chainsçš„ç±»å‹**

â€‹		ChainsåŒ…å«é€šç”¨é“¾å’Œå®ç”¨é“¾ä¸¤ç§ç±»å‹ï¼š

- **é€šç”¨é“¾ï¼š**è¿™äº›é“¾ä½¿ç”¨ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ ¹æ®ç»™å®šçš„æç¤ºç”Ÿæˆæ–‡æœ¬ã€‚æ¯”å¦‚LLMé“¾å’Œç®€å•é¡ºåºé“¾ã€‚å®ƒä»¬ä¸»è¦ä¾èµ–äºå•ä¸€çš„è¯­è¨€æ¨¡å‹æ¥å®Œæˆæ–‡æœ¬ç”Ÿæˆçš„ä»»åŠ¡ã€‚
- **å®ç”¨é“¾ï¼š**è¿™äº›é“¾å°†å¤šä¸ªå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸€èµ·ç”¨äºç‰¹å®šä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ£€ç´¢QAé“¾å¯èƒ½ç”¨äºé—®ç­”ç³»ç»Ÿï¼ŒLLMæ•°å­¦é“¾ç”¨äºå¤„ç†æ•°å­¦ç›¸å…³çš„å·¥ä½œï¼ŒåŠ è½½æ‘˜è¦é“¾ç”¨äºç”Ÿæˆæ–‡æœ¬çš„æ‘˜è¦ï¼Œè€ŒPALé“¾åˆ™å¯èƒ½ç”¨äºç‰¹å®šçš„è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚


â€‹	â‘¢ **Chainsçš„å·¥ä½œæµç¨‹**

Chainsçš„å·¥ä½œæµç¨‹ä¸ºï¼šé€šè¿‡å®šä¹‰é“¾æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–é“¾ï¼Œé…ç½®æ‰€éœ€çš„ç»„ä»¶å’Œå¯èƒ½çš„å…¶ä»–é“¾ï¼Œä»¥å½¢æˆå…·æœ‰ç‰¹å®šåŠŸèƒ½çš„æ‰§è¡Œæµç¨‹ã€‚Chainsæµç¨‹åŒ…å«ä»¥ä¸‹å››ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

- **Chain Constructorï¼ˆé“¾æ„é€ å‡½æ•°ï¼‰ï¼š**åœ¨LangChainä¸­ï¼Œé“¾æ„é€ å‡½æ•°ç”¨äºåˆå§‹åŒ–é“¾ï¼Œè®¾å®šå…¶ç»„ä»¶ã€é…ç½®åŠåµŒå¥—çš„å…¶ä»–é“¾ã€‚
- **Function Callingï¼ˆå‡½æ•°è°ƒç”¨ï¼‰**ï¼šè¿™æŒ‡é“¾æ˜¯å¦éœ€è¦è°ƒç”¨å¤–éƒ¨å‡½æ•°ï¼Œå¦‚OpenAIæœåŠ¡ï¼Œä»¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
- **Other Toolsï¼ˆå…¶ä»–å·¥å…·ï¼‰**ï¼šé™¤LangChainæ ¸å¿ƒç»„ä»¶å¤–ï¼Œé“¾å¯èƒ½è¿˜ä½¿ç”¨å…¶ä»–å·¥å…·å¦‚æ•°æ®åº“ã€APIç­‰ä»¥å¢å¼ºå…¶åŠŸèƒ½ã€‚
- **When to Useï¼ˆä½•æ—¶ä½¿ç”¨ï¼‰**ï¼šè¿™éƒ¨åˆ†æä¾›æŒ‡å¯¼ï¼Œå¸®åŠ©å¼€å‘è€…ç¡®å®šåœ¨ä½•ç§åœºæ™¯æˆ–éœ€æ±‚ä¸‹ä½¿ç”¨ç‰¹å®šçš„LangChainé“¾æœ€ä¸ºåˆé€‚ã€‚


â€‹	**â‘£ Chainsçš„æ¶æ„**

Chainsä½œä¸ºLangChainçš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡ä¸²è”å„ä¸ªé€»è¾‘å•å…ƒï¼Œå®ç°äº†æµç¨‹æ§åˆ¶ã€æ•°æ®ä¼ é€’å’ŒçŠ¶æ€ç®¡ç†ï¼Œä½¿å¾—å¤æ‚çš„ä¸šåŠ¡é€»è¾‘èƒ½å¤Ÿé«˜æ•ˆã€æœ‰åºåœ°æ‰§è¡Œã€‚

- **æµç¨‹æ§åˆ¶**ï¼šChainsé€šè¿‡ç‰¹å®šçš„é¡ºåºå°†é€»è¾‘å•å…ƒä¸²è”èµ·æ¥ï¼Œç¡®ä¿ä¸šåŠ¡æµç¨‹æŒ‰ç…§é¢„å®šçš„é¡ºåºæ‰§è¡Œã€‚æ¯ä¸ªé€»è¾‘å•å…ƒåœ¨Chainsä¸­éƒ½è¢«è§†ä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å½¢æˆäº†å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚
- **æ•°æ®ä¼ é€’**ï¼šåœ¨Chainsä¸­ï¼Œæ•°æ®åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æµåŠ¨ã€‚æ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºä½œä¸ºè¾“å…¥ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿™ç§æ•°æ®ä¼ é€’æ–¹å¼å®ç°äº†å„ä¸ªé€»è¾‘å•å…ƒä¹‹é—´çš„æ— ç¼è¡”æ¥ã€‚
- **çŠ¶æ€ç®¡ç†**ï¼šChainsè¿˜å…·å¤‡çŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼Œå…è®¸èŠ‚ç‚¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹è‡ªèº«çš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®ä¸Šä¸€æ¬¡çš„çŠ¶æ€è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™æœ‰åŠ©äºå¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚


**ï¼ˆ2ï¼‰ Chainså®è·µ**

åœ¨langchain_demo/chains_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ã€‚

å¦‚æœæƒ³å¯¹LLMè¿›è¡Œå¤æ‚çš„åº”ç”¨ï¼Œè€Œä¸æ˜¯ä»…è¿›è¡Œä¸€æ¬¡å¯¹è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†LLMä¸²è”èµ·æ¥ï¼Œè¦ä¹ˆç›¸äº’ä¸²è”ï¼Œè¦ä¹ˆä¸å…¶ä»–ç»„ä»¶ä¸²è”èµ·æ¥ã€‚æœ¬æ¨¡å—ä½¿ç”¨LLMChainæ¥å®Œæˆä¸LLMçš„å¤šè½®å¯¹è¯äº¤äº’ï¼Œè€Œå¤šè½®å¯¹è¯ä¾¿æ˜¯ä¸€ä¸ªé“¾å¼è°ƒç”¨çš„è¿‡ç¨‹ï¼Œä»¥ä»¥ä¸‹åœºæ™¯ä¸ºä¾‹ï¼š

- å‘é²èœå¨å¸ˆï¼ˆSystemï¼‰å’¨è¯¢ä½äºé’å²›çš„é²èœèœé¦†æ¨è
- ç»§ç»­å‘å®ƒå’¨è¯¢åˆé¥­çš„èœå“æ¨è
- å¯¹äºå®ƒæ¨èçš„èœå“ï¼Œå‘å®ƒæé—®å…·ä½“åšæ³•

   é¦–å…ˆæ²¿ç”¨ä¹‹å‰å®éªŒçš„èŠå¤©æ¨¡å‹æç¤ºè¯ï¼Œå¹¶æ„å»ºç¬¬ä¸€ä¸ªLLMChainï¼Œâ€œå‘é²èœå¨å¸ˆï¼ˆSystemï¼‰å’¨è¯¢ä½äºé’å²›çš„é²èœèœé¦†æ¨èâ€ã€‚

   LangChainçš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªLLMå’Œä¸€ä¸ªPromptTemplateä½œä¸ºå‚æ•°ã€‚æ„é€ å®Œæˆä¹‹åå¯ä»¥ç›´æ¥è°ƒç”¨é‡Œé¢çš„runæ–¹æ³•ï¼Œå°†PromptTemplateæ‰€éœ€è¦çš„å˜é‡ï¼Œé€šè¿‡K=>Vå¯¹çš„å½¢å¼ä¼ å…¥è¿›å»ï¼Œè¿”å›çš„ç»“æœå°±æ˜¯LLMå›ç­”çš„ç­”æ¡ˆã€‚

```python
from langchain.chat_models import ChatOpenAI
from langchain.chains import SimpleSequentialChain
from langchain.prompts.chat import (
    ChatPromptTemplate,
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
)
from langchain.chains import LLMChain
openai_api_base = "http://localhost:8000/v1"
openai_api_key = "EMPTY"
model = ChatOpenAI(model_name="Qwen",
                  temperature=0.5,
                   openai_api_base=openai_api_base,
                   openai_api_key=openai_api_key)
system_template = '''ä½ æ˜¯ä¸€åå‡ºè‰²çš„é²èœå¨å¸ˆã€‚'''
system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{test}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)

chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])

restaurant_chain = LLMChain(llm = model, prompt = chat_prompt)
```

   é»˜è®¤æƒ…å†µä¸‹ï¼Œ__call__åŒæ—¶è¿”å›è¾“å…¥å’Œè¾“å‡ºçš„é”®å€¼ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½®return_only_outputsä¸ºTrueï¼Œå°†å…¶é…ç½®ä¸ºåªè¿”å›è¾“å‡ºé”®å€¼ã€‚

```
print(restaurant_chain('è¯·ä¸ºæˆ‘æ¨èä¸€å®¶ä½äºé’å²›çš„è‘—åé²èœèœé¦†', return_only_outputs=True))
```

   å¦‚æœå¸Œæœ›Chainåªè¾“å‡ºä¸€ä¸ªè¾“å‡ºé”®ï¼ˆå³å®ƒçš„output_keysä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨runæ–¹æ³•ã€‚æ³¨æ„ï¼Œrunä¼šè¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯ä¸€ä¸ªå­—å…¸ã€‚

```
print(restaurant_chain.run('è¯·ä¸ºæˆ‘æ¨èä¸€å®¶ä½äºé’å²›çš„è‘—åé²èœèœé¦†'))
```

   æ„å»ºç¬¬äºŒä¸ªLLMChainï¼Œâ€œç»§ç»­å‘å®ƒå’¨è¯¢åˆé¥­çš„èœå“æ¨èâ€

```
system_template = '''è¯·åœ¨èœé¦†ä¸­ä¸ºæˆ‘çš„åˆé¥­æ¨èä¸‰é“é¥­èœ'''
system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{test}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)
chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])
meal_chain = LLMChain(llm = model, prompt = chat_prompt)
```

   æ„å»ºç¬¬ä¸‰ä¸ªLLMChainï¼Œâ€œå¯¹äºå®ƒæ¨èçš„èœå“ï¼Œå‘å®ƒæé—®å…·ä½“åšæ³•â€

```
system_template = '''è¯·è®²è§£è¿™äº›é¥­èœçš„å…·ä½“åšæ³•'''
system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{test}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)

chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])
recipe_chain = LLMChain(llm = model, prompt = chat_prompt)
```

   ä½¿ç”¨SimpleSequentialChain(chainsä¸­çš„LLMChainç±»ï¼Œå°†æˆ‘ä»¬éœ€è¦æŒ‰é¡ºåºä¾æ¬¡è°ƒç”¨çš„ä¸‰ä¸ªLLMChainæ”¾åœ¨ä¸€ä¸ªæ•°ç»„é‡Œï¼Œä¼ ç»™è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ã€‚å¯¹äºè¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬è°ƒç”¨runæ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬çš„ä¸­æ–‡é—®é¢˜äº¤ç»™å®ƒã€‚è¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªSimpleSequentialChainå°±ä¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è°ƒç”¨chainsè¿™ä¸ªæ•°ç»„ä¸­å‚æ•°é‡ŒåŒ…å«çš„LLMChainã€‚å¹¶ä¸”ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨çš„ç»“æœéƒ½ä¼šå­˜å‚¨åœ¨è¿™ä¸ªChainæ„é€ æ—¶å®šä¹‰çš„output_keyå‚æ•°é‡Œã€‚è€Œä¸‹ä¸€æ¬¡è°ƒç”¨çš„LLMChainçš„æ¨¡æ¿å†…çš„å˜é‡å¦‚æœæœ‰å’Œä¹‹å‰çš„output_keyåå­—ç›¸åŒçš„ï¼Œå°±ä¼šç”¨output_keyé‡Œå­˜å…¥çš„å†…å®¹æ›¿æ¢æ‰æ¨¡æ¿å†…å˜é‡æ‰€åœ¨çš„å ä½ç¬¦ã€‚

```
overall_chain = SimpleSequentialChain(chains=[restaurant_chain, meal_chain, recipe_chain], verbose = True)  #verboseå¼€å¯æç¤ºç¬¦

review = overall_chain.run("è¯·ä¸ºæˆ‘æ¨èä¸€å®¶ä½äºé’å²›çš„è‘—åé²èœèœé¦†")
```

   ä»£ç ç¼–å†™å®Œæ¯•åï¼Œè¿è¡Œchains_demo.pyæ–‡ä»¶ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240611%2Fcad704bc3e294587b0346c5bf19cbd6a.png)

#### 3.3 **Callbacks**

   **ï¼ˆ1ï¼‰CallbacksåŸºæœ¬æ¦‚å¿µ**

   LangChainæä¾›äº†å›è°ƒç³»ç»Ÿï¼Œå…è®¸è¿æ¥åˆ°å¤§è¯­è¨€æ¨¡å‹åº”ç”¨ç¨‹åºçš„å„ä¸ªé˜¶æ®µã€‚è¿™å¯¹äºæ—¥å¿—è®°å½•ã€ç›‘æ§ã€æµå¼å¤„ç†å’Œå…¶ä»–ä»»åŠ¡éå¸¸æœ‰ç”¨ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨APIä¸­æä¾›çš„callbackså‚æ•°è®¢é˜…è¿™äº›äº‹ä»¶ã€‚CallbackHandlers æ˜¯å®ç° CallbackHandler æ¥å£çš„å¯¹è±¡ï¼Œæ¯ä¸ªäº‹ä»¶éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–¹æ³•è®¢é˜…ã€‚å½“äº‹ä»¶è§¦å‘æ—¶ï¼ŒCallbackManager ä¼šè°ƒç”¨ç›¸åº”äº‹ä»¶æ‰€å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚

```
class BaseCallbackHandler:
    """Base callback handler that can be used to handle callbacks from langchain."""

    def on_llm_start(
        self, serialized: Dict[str, Any], prompts: List[str], **kwargs: Any
    ) -> Any:
        """Run when LLM starts running."""

    def on_chat_model_start(
        self, serialized: Dict[str, Any], messages: List[List[BaseMessage]], **kwargs: Any
    ) -> Any:
        """Run when Chat Model starts running."""

    def on_llm_new_token(self, token: str, **kwargs: Any) -> Any:
        """Run on new LLM token. Only available when streaming is enabled."""

    def on_llm_end(self, response: LLMResult, **kwargs: Any) -> Any:
        """Run when LLM ends running."""

    def on_llm_error(
        self, error: Union[Exception, KeyboardInterrupt], **kwargs: Any
    ) -> Any:
        """Run when LLM errors."""

    def on_chain_start(
        self, serialized: Dict[str, Any], inputs: Dict[str, Any], **kwargs: Any
    ) -> Any:
        """Run when chain starts running."""

    def on_chain_end(self, outputs: Dict[str, Any], **kwargs: Any) -> Any:
        """Run when chain ends running."""

    def on_chain_error(
        self, error: Union[Exception, KeyboardInterrupt], **kwargs: Any
    ) -> Any:
        """Run when chain errors."""

    def on_tool_start(
        self, serialized: Dict[str, Any], input_str: str, **kwargs: Any
    ) -> Any:
        """Run when tool starts running."""

    def on_tool_end(self, output: Any, **kwargs: Any) -> Any:
        """Run when tool ends running."""

    def on_tool_error(
        self, error: Union[Exception, KeyboardInterrupt], **kwargs: Any
    ) -> Any:
        """Run when tool errors."""

    def on_text(self, text: str, **kwargs: Any) -> Any:
        """Run on arbitrary text."""

    def on_agent_action(self, action: AgentAction, **kwargs: Any) -> Any:
        """Run on agent action."""

    def on_agent_finish(self, finish: AgentFinish, **kwargs: Any) -> Any:
        """Run on agent end."""
```

   **ï¼ˆ2ï¼‰å¸¸ç”¨çš„Callbacksç±»å‹**

- **StdOutCallbackHandlerï¼š**å°†æ‰€æœ‰äº‹ä»¶çš„æ—¥å¿—ä½œä¸ºæ ‡å‡†è¾“å‡ºï¼Œæ‰“å°åˆ°ç»ˆç«¯ä¸­ã€‚æ³¨æ„ï¼Œå½“verboseå‚æ•°è®¾ç½®ä¸ºTrueæ—¶ï¼ŒStdOutCallbackHandleræ˜¯é»˜è®¤è¢«å¯ç”¨çš„ï¼Œå³è¿è¡Œè¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¼šè¢«å…¨éƒ¨æ‰“å°åˆ°ç»ˆç«¯ä¸­ã€‚
- **AsyncCallbackHandlerï¼š**å¼‚æ­¥å›è°ƒå‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨å¼‚æ­¥APIï¼Œå»ºè®®ä½¿ç”¨AsyncCallbackHandlerä»¥é¿å…é˜»å¡è¿è¡Œå¾ªç¯ã€‚å¦‚æœåœ¨ä½¿ç”¨å¼‚æ­¥æ–¹æ³•è¿è¡ŒLLMã€Chainã€Toolã€Agentæ—¶ä½¿ç”¨åŒæ­¥çš„CallbackHandlerï¼Œå®ƒä»ç„¶å¯ä»¥å·¥ä½œã€‚ä½†åœ¨å†…éƒ¨ï¼Œå®ƒå°†ä½¿ç”¨run_in_executorè°ƒç”¨ï¼Œå¦‚æœæ‚¨çš„CallbackHandlerä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚
- **FileCallbackHandlerï¼š**å¼€å‘é¡¹ç›®è¿‡ç¨‹ä¸­ï¼Œå†™æ—¥å¿—æ˜¯é‡è¦çš„è°ƒè¯•æ‰‹æ®µä¹‹ä¸€ã€‚æ­£å¼çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½æ€»æ˜¯å°†æ—¥å¿—è¾“å‡ºåˆ°ç»ˆç«¯ä¸­ï¼Œè¿™æ ·æ— æ³•ä¼ é€’å’Œä¿å­˜ã€‚
- **get_openai_callback:** ä½¿ç”¨è¯¥å›è°ƒå‡½æ•°æ¥è·å–tokenæ¶ˆè€—ã€‚

   **ï¼ˆ3ï¼‰Callbackså®è·µ**

   åœ¨callback_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ã€‚

   å›è°ƒå‡½æ•°å¯åœ¨æ„é€ å‡½æ•°ä¸­å›è°ƒï¼Œä¹Ÿå¯ä»¥åœ¨è¯·æ±‚å‡½æ•°ä¸­å›è°ƒï¼š

- æ„é€ å‡½æ•°å›è°ƒï¼šåœ¨æ„é€ å‡½æ•°ä¸­å®šä¹‰ï¼Œä¾‹å¦‚LLMChain(callbacks=[handler], tags=['a-tag'])ï¼Œå®ƒå°†è¢«ç”¨äºå¯¹è¯¥å¯¹è±¡çš„æ‰€æœ‰è°ƒç”¨ï¼Œå¹¶ä¸”å°†åªé’ˆå¯¹è¯¥å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å‘LLMChainæ„é€ å‡½æ•°ä¼ é€’ä¸€ä¸ªhandlerï¼Œå®ƒå°†ä¸ä¼šè¢«é™„å±äºè¯¥é“¾çš„Modelä½¿ç”¨ã€‚æ„é€ å‡½æ•°å›è°ƒå¯¹è¯¸å¦‚æ—¥å¿—ã€ç›‘æ§ç­‰ç”¨ä¾‹æœ€æœ‰ç”¨ï¼Œè¿™äº›ç”¨ä¾‹ä¸æ˜¯é’ˆå¯¹å•ä¸ªè¯·æ±‚ï¼Œè€Œæ˜¯é’ˆå¯¹æ•´ä¸ªé“¾ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³è®°å½•æ‰€æœ‰å‘LLMChainå‘å‡ºçš„è¯·æ±‚ï¼Œä½ å¯ä»¥å‘æ„é€ å‡½æ•°ä¼ é€’ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚
- è¯·æ±‚å‡½æ•°å›è°ƒï¼šå®šä¹‰åœ¨ç”¨äºå‘å‡ºè¯·æ±‚çš„call()/run()/apply()æ–¹æ³•ä¸­ï¼Œä¾‹å¦‚chain.run(inputs, callbacks=[handler])ï¼Œå®ƒå°†ä»…ç”¨äºè¯¥ç‰¹å®šè¯·æ±‚ï¼Œä»¥åŠå®ƒåŒ…å«çš„æ‰€æœ‰å­è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œå¯¹LLMChainçš„è°ƒç”¨ä¼šè§¦å‘å¯¹Modelçš„è°ƒç”¨ï¼Œè¯¥Modelä½¿ç”¨run()æ–¹æ³•ä¸­ä¼ é€’çš„ç›¸åŒhandlerã€‚

   æ–¹æ³•ä¸€ï¼Œæ„é€ å‡½æ•°å›è°ƒï¼Œåœ¨åˆå§‹åŒ–é“¾æ—¶æ˜¾å¼è®¾ç½®StdOutCallbackHandlerã€‚

```
print('*****æ„é€ å‡½æ•°å›è°ƒï¼Œåœ¨åˆå§‹åŒ–é“¾æ—¶æ˜¾å¼è®¾ç½®StdOutCallbackHandler*****')
from langchain.callbacks import StdOutCallbackHandler
from langchain.chat_models import ChatOpenAI
from langchain.chains import LLMChain
from langchain.prompts.chat import (
    ChatPromptTemplate,
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
)



openai_api_base = "http://localhost:8000/v1"
openai_api_key = "EMPTY"
model = ChatOpenAI(model_name="Qwen",
                  temperature=0,
                   openai_api_base=openai_api_base,
                   openai_api_key=openai_api_key)

system_template = '''ä½ éœ€è¦æ ¹æ®ç”¨æˆ·çš„é¥®é£Ÿéœ€æ±‚æ¨èä½äºé’å²›çš„åˆé€‚çš„é¤å…ã€‚'''
system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{input}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)

chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])
handler = StdOutCallbackHandler()
restaurant_chain = LLMChain(llm=model, prompt=chat_prompt, callbacks=[handler])
print(restaurant_chain.run(input='é²èœ'))
```

   æ–¹æ³•äºŒï¼Œå°†verboseå‚æ•°è®¾ç½®ä¸ºTrueï¼Œé»˜è®¤å¯ç”¨StdOutCallbackHandlerå›è°ƒï¼š

```
print('****************************ä½¿ç”¨verboseå±æ€§***************************')
restaurant_chain = LLMChain(llm=model, prompt=chat_prompt, verbose=True)
print(restaurant_chain.run(input='é²èœ'))
```

   æ–¹æ³•ä¸‰ï¼Œä½¿ç”¨è¯·æ±‚å›è°ƒï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚

```
print('******************************ä½¿ç”¨è¯·æ±‚å›è°ƒ*****************************')
restaurant_chain = LLMChain(llm=model, prompt=chat_prompt)
print(restaurant_chain.run(input='é²èœ', callbacks=[handler]))
```

   ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨ï¼š

```
print('*****************************ä½¿ç”¨è‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨************************')
from langchain.callbacks.base import BaseCallbackHandler
from langchain.chat_models import ChatOpenAI
from langchain.schema import HumanMessage

# è‡ªå®šä¹‰å›è°ƒå‡½æ•°
class MyCustomHandler(BaseCallbackHandler):
    def on_llm_new_token(self, token: str, **kwargs):
        print(f"My custom handler, token: {token}")

print('--with callback--')
chat = ChatOpenAI(model_name="Qwen",
                    temperature=0,
                    openai_api_base=openai_api_base,
                    openai_api_key=openai_api_key,
                    streaming=True,
                    max_tokens=200,
                    callbacks=[MyCustomHandler()])
chat([HumanMessage(content="ç»™æˆ‘è®²ä¸ªç¬‘è¯")])


print('--without callback--')
model = ChatOpenAI(model_name="Qwen",
                    temperature=0,
                    openai_api_base=openai_api_base,
                    openai_api_key=openai_api_key,
                    streaming=True,
                    max_tokens=200)
print(model([HumanMessage(content="ç»™æˆ‘è®²ä¸ªç¬‘è¯")]))
```

   ä»£ç ç¼–å†™å®Œæ¯•åï¼Œè¿è¡Œcallback_demo.pyæ–‡ä»¶ã€‚

   æ„é€ å‡½æ•°å›è°ƒï¼Œåœ¨åˆå§‹åŒ–é“¾æ—¶æ˜¾å¼è®¾ç½®StdOutCallbackHandlerï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2Ff0f3382717124744af34ac712c54e12d.png)

   ä½¿ç”¨verboseå±æ€§ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F7a5aa10f9d0549d480b39af99c605852.png)

   ä½¿ç”¨è¯·æ±‚å›è°ƒï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F579cab4541dc4b0d9db705a9a0b3d3f4.png)

   å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ä¸Šè¿°3ç§ä¸åŒçš„å›è°ƒå‡½æ•°è®¾ç½®æ–¹å¼ï¼Œå¯ä»¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚

   è‡ªå®šä¹‰å›è°ƒå¤„ç†å™¨ï¼Œä½¿ç”¨å›è°ƒå‡½æ•°å’Œä¸ä½¿ç”¨å›è°ƒå‡½æ•°æ•ˆæœå¯¹æ¯”å¦‚ä¸‹ï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F3a1a55b5702e4ee8afea8c7c65094d2f.png)

#### 3.4 **Memory**

   **ï¼ˆ1ï¼‰Memoryçš„æ¦‚å¿µ**

   å¤§å¤šæ•°å¤§è¯­è¨€æ¨¡å‹åº”ç”¨éƒ½ä½¿ç”¨å¯¹è¯æ–¹å¼ä¸ç”¨æˆ·äº¤äº’ã€‚å¯¹è¯ä¸­çš„ä¸€ä¸ªå…³é”®ç¯èŠ‚æ˜¯èƒ½å¤Ÿå¼•ç”¨å’Œå‚è€ƒä¹‹å‰å¯¹è¯ä¸­çš„ä¿¡æ¯ã€‚å¯¹äºå¯¹è¯ç³»ç»Ÿæ¥è¯´ï¼Œæœ€åŸºç¡€çš„è¦æ±‚æ˜¯èƒ½å¤Ÿç›´æ¥è®¿é—®ä¸€äº›è¿‡å»çš„æ¶ˆæ¯ã€‚åœ¨æ›´å¤æ‚çš„ç³»ç»Ÿä¸­è¿˜éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿä¸æ–­æ›´æ–°çš„ä¸–ç•Œæ¨¡å‹ï¼Œä½¿å…¶èƒ½å¤Ÿç»´æŠ¤æœ‰å…³å®ä½“åŠå…¶å…³ç³»çš„ä¿¡æ¯ã€‚åœ¨Langchainä¸­ï¼Œè¿™ç§å­˜å‚¨å…³äºè¿‡å»äº¤äº’ä¿¡æ¯çš„èƒ½åŠ›è¢«ç§°ä¸ºâ€œè®°å¿†â€ã€‚Langchainä¸­æä¾›äº†è®¸å¤šç”¨äºå‘ç³»ç»Ÿä¸­æ·»åŠ è®°å¿†çš„æ–¹æ³•ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥æ— ç¼åœ°æ•´åˆåˆ°é“¾ä¸­ã€‚

   **ï¼ˆ2ï¼‰Memoryæ¨¡å—çš„åŸºæœ¬æ¡†æ¶**

   Memoryæ¨¡å—çš„åŸºæœ¬æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè®°å¿†ç³»ç»Ÿéœ€è¦æ”¯æŒä¸¤ä¸ªåŸºæœ¬æ“ä½œï¼šè¯»å–å’Œå†™å…¥ã€‚æ¯ä¸ªé“¾éƒ½æ ¹æ®è¾“å…¥å®šä¹‰äº†æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ã€‚å…¶ä¸­ä¸€äº›è¾“å…¥ç›´æ¥æ¥è‡ªç”¨æˆ·ï¼Œä½†æœ‰äº›è¾“å…¥å¯ä»¥æ¥æºäºè®°å¿†ã€‚åœ¨æ¥æ”¶åˆ°åˆå§‹ç”¨æˆ·è¾“å…¥ï¼Œä½†åœ¨æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ä¹‹å‰ï¼Œé“¾å°†ä»è®°å¿†ç³»ç»Ÿä¸­è¯»å–å†…å®¹å¹¶å¢å¼ºç”¨æˆ·è¾“å…¥ã€‚åœ¨æ ¸å¿ƒé€»è¾‘æ‰§è¡Œå®Œæ¯•å¹¶åœ¨è¿”å›ç­”å¤ä¹‹å‰ï¼Œé“¾ä¼šå°†è¿™ä¸€è½®çš„è¾“å…¥å’Œè¾“å‡ºéƒ½ä¿å­˜åˆ°è®°å¿†ç³»ç»Ÿä¸­ï¼Œä»¥ä¾¿åœ¨å°†æ¥ä½¿ç”¨ä»–ä»¬ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240507%2Faecca826dccb406ba9181dd259e7055e.png)

   **ï¼ˆ3ï¼‰****Memoryçš„ç±»å‹**

   åœ¨LangChainä¸­æä¾›äº†å¤šç§è®°å¿†æ–¹å¼çš„æ”¯æŒï¼Œåˆ—ä¸¾ä»¥ä¸‹å‡ ä¸ªï¼š

- ConversationBufferMemoryï¼šåªæ˜¯å°†èŠå¤©æ¶ˆæ¯åˆ—è¡¨ä¿å­˜åˆ°ç¼“å†²åŒºä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’åˆ°æç¤ºæ¨¡æ¿ä¸­ã€‚
- ConversationBufferWindowMemoryï¼šå…è®¸ç”¨æˆ·è®¾ç½®ä¸€ä¸ªè¶…å‚æ•°Kï¼Œæ¥é™å®šæ¯æ¬¡ä»è®°å¿†ä¸­è¯»å–æœ€è¿‘çš„Kæ¡è®°å¿†ã€‚
- ConversationEntityMemoryï¼šä¿å­˜ä¸€äº›å®ä½“ä¿¡æ¯ï¼Œå¦‚ä»è¾“å…¥ä¸­æ‰¾å‡ºä¸€ä¸ªäººåï¼Œä¿å­˜è¿™ä¸ªäººçš„ä¿¡æ¯ã€‚
- ConversationSummaryMemoryï¼šå¯¹ä¸Šä¸‹æ–‡åšæ‘˜è¦ã€‚
- ConversationSummaryBufferMemoryï¼šä¿å­˜Tokené™åˆ¶å†…çš„ä¸Šä¸‹æ–‡ï¼Œå¯¹æ›´æ—©çš„åšæ‘˜è¦ã€‚
- ConversationTokenBufferMemoryï¼šå…è®¸ç”¨æˆ·æ‰§è¡Œæœ€å¤§çš„tokené•¿åº¦ï¼Œä½¿å¾—ä»è®°å¿†ä¸­å–ä¸Šä¸‹æ–‡æ—¶ä¸ä¼šè¶…è¿‡tokené™åˆ¶ã€‚
- VectorStoreRetrieverMemoryï¼šå°† Memory å­˜å‚¨åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼Œæ ¹æ®ç”¨æˆ·è¾“å…¥æ£€ç´¢å›æœ€ç›¸å…³çš„éƒ¨åˆ†

   **ï¼ˆ4ï¼‰****Memoryå®è·µ**

   **åœ¨**memory_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ã€‚

   é¦–å…ˆä½¿ç”¨ConversationBufferWindowMemoryç±»å‹ï¼Œåœ¨æ„é€ LLMChainæ—¶ä¸ºå®ƒæŒ‡å®šä¸€ä¸ªConversationBufferWindowMemoryçš„memoryå¯¹è±¡ï¼Œå¹¶ä¸”å°†è¿™ä¸ªå¯¹è±¡çš„chat_historyè®¾ç½®ä¸ºk=3ï¼Œå³åªä¿ç•™æœ€è¿‘ä¸‰è½®çš„å¯¹è¯å†…å®¹ã€‚

```
print('************ä½¿ç”¨ConversationBufferWindowMemoryÃ—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—')
from langchain.memory import ConversationBufferWindowMemory
from langchain.chat_models import ChatOpenAI
from langchain.chains import LLMChain
from langchain.prompts.chat import (
    ChatPromptTemplate,
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
)

openai_api_base = "http://localhost:8000/v1"
openai_api_key = "EMPTY"
model = ChatOpenAI(model_name="Qwen",
                  temperature=0,
                   openai_api_base=openai_api_base,
                   openai_api_key=openai_api_key)

system_template = '''ä½ æ˜¯é’å²›çš„ä¸€åå‡ºè‰²çš„é²èœå¨å¸ˆï¼Œç°åœ¨æ­£åœ¨ç½‘ä¸Šå›ç­”æ¥é’å²›æ—…æ¸¸çš„æ¸¸å®¢çš„é—®é¢˜ï¼Œä½ çš„å›ç­”éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚:
1. ä½ çš„å›ç­”å¿…é¡»æ˜¯ä¸­æ–‡
2. å›ç­”é™åˆ¶åœ¨200ä¸ªå­—ä»¥å†…
{chat_history}
'''
system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{input}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)

chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])

memory = ConversationBufferWindowMemory(memory_key="chat_history", k=3)
llm_chain = LLMChain(
    llm=model,
    prompt=chat_prompt,
    memory=memory,
    verbose=True
)

print(llm_chain.predict(input="è¯·ä¸ºæˆ‘æ¨èä¸€å®¶åˆé€‚çš„é²èœèœé¦†"))

print(llm_chain.predict(input="è¯·ä¸ºæˆ‘æ¨èè¿™å®¶é¤å…ä¸­çš„èœå“"))

print(llm_chain.predict(input="è¯·å‘Šè¯‰æˆ‘é’å²›å•¤é…’çƒ¤è™¾çš„å…·ä½“åšæ³•"))

print(llm_chain.predict(input="æˆ‘å‘ä½ æé—®çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"))
```

   BufferWindowè¿™æ ·çš„æ»‘åŠ¨çª—å£æœ‰å‡ ä¸ªåå¤„ï¼Œå°±æ˜¯åœ¨å‡ è½®å¯¹è¯ä¹‹åä¼šæŠŠä¹‹å‰çš„å¯¹è¯è®°å½•å¿˜è®°ï¼Œå¹¶ä¸”æ¯æ¬¡ä¿å­˜å®Œæ•´çš„å¯¹è¯åˆ—è¡¨ä¼šå¯¼è‡´å ç”¨è¿‡å¤§çš„tokenã€‚LangChainä¸­æä¾›äº†ä¸€ä¸ªConversationSummaryBufferMemoryï¼Œå®ƒå¯ä»¥è®©AIå»æ€»ç»“å‰å‡ è½®çš„å¯¹è¯å†…å®¹ï¼Œè¿™æ ·å°±ä¸æ‹…å¿ƒå¯¹è¯è½®æ•°å¤ªå¤šæˆ–è€…è¿‡é•¿äº†ã€‚

   ConversationSummaryMemoryçš„æ„é€ å‡½æ•°ä¹Ÿæ¥æ”¶ä¸€ä¸ªLLMå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸“é—¨ç”¨äºå¯¹å†å²å¯¹è¯ç”Ÿæˆå°ç»“ï¼Œå®ƒä¸å¯¹è¯æœ¬èº«ä½¿ç”¨çš„LLMå¯ä»¥ä¸ä¸€è‡´ã€‚

```
print('Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—ä½¿ç”¨ConversationSummaryMemoryÃ—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—')
from langchain.memory import ConversationSummaryMemory
from langchain.chains import ConversationChain
from langchain.prompts.chat import (
    ChatPromptTemplate,
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
)

system_template = '''ä½ æ˜¯é’å²›çš„ä¸€åå‡ºè‰²çš„é²èœå¨å¸ˆï¼Œç°åœ¨æ­£åœ¨ç½‘ä¸Šå›ç­”æ¥é’å²›æ—…æ¸¸çš„æ¸¸å®¢çš„é—®é¢˜ï¼Œä½ çš„å›ç­”éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚:
1. ä½ çš„å›ç­”å¿…é¡»æ˜¯ä¸­æ–‡
2. å›ç­”é™åˆ¶åœ¨200ä¸ªå­—ä»¥å†…
{chat_history}
'''

system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
human_template = '''{input}'''
human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)
chat_prompt = ChatPromptTemplate.from_messages([system_message_prompt, human_message_prompt])

memory = ConversationSummaryMemory(memory_key="chat_history", llm=model)
conversation_with_summary = ConversationChain(
    llm=model,
    prompt=chat_prompt,
    memory=memory,
    verbose=True
)

print(conversation_with_summary.predict(input="è¯·ä¸ºæˆ‘æ¨èä¸€å®¶åˆé€‚çš„é²èœèœé¦†"))

print(conversation_with_summary.predict(input="è¯·ä¸ºæˆ‘æ¨èè¿™å®¶é¤å…ä¸­çš„èœå“"))

print(conversation_with_summary.predict(input="è¯·å‘Šè¯‰æˆ‘è‘±çƒ§æµ·å‚çš„å…·ä½“åšæ³•"))

print(conversation_with_summary.predict(input="æˆ‘å‘ä½ æé—®çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"))
```

   ä»£ç ç¼–å†™å®Œæ¯•åï¼Œè¿è¡Œmemory_demo.pyæ–‡ä»¶ï¼Œå®éªŒç»“æœå¦‚ä¸‹ï¼š

   ä½¿ç”¨ConversationBufferWindowMemoryè®°å¿†ç±»å‹ï¼Œå®éªŒç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè“æ¡†ä¸­çš„å†…å®¹ä¸ºä¿å­˜çš„â€è®°å¿†â€œï¼Œçº¢æ¡†ä¸­çš„å†…å®¹ä¸ºLLMæ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆçš„å›ç­”ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F4eb56a611cb24df0909543f643719f88.png)

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2Fb102c17270f149c89b86a8230bc8ee0d.png)

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F7bc76612200c4d39a39b254d640ed424.png)

   ä½¿ç”¨ConversationSummaryMemoryè®°å¿†ç±»å‹ï¼Œå®éªŒç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®éªŒç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè“æ¡†ä¸­çš„å†…å®¹ä¸ºä¿å­˜çš„â€è®°å¿†â€œï¼Œæ˜¯LLMAIæ€»ç»“çš„å‰å‡ è½®çš„å¯¹è¯å†…å®¹ï¼ˆæ‘˜è¦ï¼‰ï¼›çº¢æ¡†ä¸­çš„å†…å®¹ä¸ºLLMæ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆçš„å›ç­”ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F4c6d26c2e7174cc1ad4d67294422e161.png)

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2Fd442d97aa1ce413dad25def5af4a87a2.png)

#### 3.5 **æ£€ç´¢ï¼ˆRetrievalï¼‰**

   **ï¼ˆ1ï¼‰** **æ£€ç´¢ï¼ˆRetrievalï¼‰ç®€ä»‹**

   LangChainé€šè¿‡å…¶Retrievalç»„ä»¶ç®€åŒ–äº†æ£€ç´¢å¢å¼ºç”Ÿæˆ(RAG)è¿‡ç¨‹ä¸­å¤–éƒ¨æ•°æ®çš„æ£€ç´¢ä¸ç®¡ç†ï¼Œä¸ºLLMåº”ç”¨é«˜æ•ˆåœ°æä¾›äº†ç”¨æˆ·ç‰¹å®šçš„æ•°æ®ã€‚ä¸»è¦å·¥ä½œæµç¨‹ä¸ºï¼šä»æŒ‡å®šæ¥æºè·å–å¹¶è¯»å–æ–‡æ¡£ï¼Œç»è¿‡é¢„å¤„ç†å’Œå‘é‡åŒ–åï¼Œå°†æ–‡æ¡£å­˜å‚¨å¹¶ç´¢å¼•åŒ–ï¼Œæœ€ç»ˆæ ¹æ®ç”¨æˆ·æŸ¥è¯¢è¿›è¡Œé«˜æ•ˆæœç´¢å¹¶è¿”å›ç›¸å…³ç»“æœã€‚Retrievalæ¨¡å—çš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240507%2F067f4a3215ef40339d17d75265d34715.png)

   Retrievalæµç¨‹åŒ…å«ä»¥ä¸‹å…­ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

- **Sourceï¼ˆæ¥æºï¼‰ï¼š**å…³é”®è¯ï¼š**è·å–**ï¼Œè¡¨ç¤ºä»å„ç§æ¥æºè·å–æ–‡æ¡£æˆ–æ•°æ®ã€‚
- **Loadï¼ˆåŠ è½½ï¼‰ï¼š**å…³é”®è¯ï¼š**è¯»å–**ï¼Œä»£è¡¨ä»æ¥æºä¸­åŠ è½½å¹¶è¯»å–æ–‡æ¡£æˆ–æ•°æ®çš„è¿‡ç¨‹ã€‚
- **Transformï¼ˆè½¬æ¢ï¼‰ï¼š**å…³é”®è¯ï¼š**é¢„å¤„ç†**ï¼Œè¡¨ç¤ºå¯¹åŠ è½½çš„æ–‡æ¡£æˆ–æ•°æ®è¿›è¡Œæ¸…æ´—ã€æ ¼å¼åŒ–å’Œè½¬æ¢ï¼Œä»¥é€‚åº”åç»­æ­¥éª¤ã€‚
- **Embedï¼ˆåµŒå…¥ï¼‰ï¼š**å…³é”®è¯ï¼š**å‘é‡åŒ–**ï¼Œä»£è¡¨å°†æ–‡æ¡£æˆ–æ•°æ®è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼Œä»¥æ•æ‰å…¶è¯­ä¹‰ä¿¡æ¯ã€‚
- **Storeï¼ˆå­˜å‚¨ï¼‰ï¼š**å…³é”®è¯ï¼š**ç´¢å¼•åŒ–**ï¼Œè¡¨ç¤ºå°†åµŒå…¥åçš„å‘é‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¹¶å»ºç«‹ç´¢å¼•ä»¥ä¼˜åŒ–æ£€ç´¢æ€§èƒ½ã€‚
- **Retrieveï¼ˆæ£€ç´¢ï¼‰ï¼š**å…³é”®è¯ï¼š**æœç´¢**ï¼Œä»£è¡¨æ ¹æ®ç”¨æˆ·æŸ¥è¯¢ä»å­˜å‚¨çš„å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³æ–‡æ¡£æˆ–æ•°æ®çš„è¿‡ç¨‹ã€‚

   **Retrievalçš„æ ¸å¿ƒç»„ä»¶ï¼š****Retrievalçš„å…­ä¸ªæ ¸å¿ƒç»„ä»¶å…±åŒåä½œï¼Œå®ç°æ–‡æ¡£çš„é«˜æ•ˆåŠ è½½ã€ç²¾ç¡®æ‹†åˆ†ã€è¯­ä¹‰åµŒå…¥ã€å‘é‡å­˜å‚¨ã€æ™ºèƒ½æ£€ç´¢åŠä¼˜åŒ–ç´¢å¼•ï¼Œä¸ºå„ç±»åº”ç”¨åœºæ™¯æä¾›å¼ºå¤§ä¸”çµæ´»çš„æ–‡æ¡£å¤„ç†ä¸æ£€ç´¢èƒ½åŠ›ã€‚**

   **â‘  æ–‡æ¡£åŠ è½½ (Document Loaders)**

- åŠŸèƒ½ï¼šä»å¤šç§æ¥æºåŠ è½½æ–‡æ¡£ã€‚
- ç‰¹æ€§ï¼šæ”¯æŒ100+åŠ è½½å™¨ï¼Œä¸AirByteã€Unstructuredç­‰é›†æˆã€‚
- åº”ç”¨ï¼šåŠ è½½HTMLã€PDFã€ä»£ç ç­‰ï¼Œæ¥æºåŒ…æ‹¬ç§æœ‰S3æ¡¶ã€å…¬å…±ç½‘ç«™ç­‰ã€‚

   **â‘¡ æ–‡æœ¬æ‹†åˆ† (Text Splitting)**

- åŠŸèƒ½ï¼šå°†å¤§æ–‡æ¡£æ‹†åˆ†ä¸ºå°ç‰‡æ®µï¼Œä»¥ä¾¿æ›´ç²¾ç¡®åœ°æ£€ç´¢ç›¸å…³å†…å®¹ã€‚
- ç‰¹æ€§ï¼šæä¾›å¤šç§æ‹†åˆ†ç®—æ³•ï¼Œä¼˜åŒ–ç‰¹å®šæ–‡æ¡£ç±»å‹ï¼ˆå¦‚ä»£ç ã€Markdownï¼‰ã€‚

   **â‘¢ æ–‡æœ¬åµŒå…¥æ¨¡å‹ (Text Embedding Models)**

- åŠŸèƒ½ï¼šä¸ºæ–‡æ¡£åˆ›å»ºè¯­ä¹‰åµŒå…¥ï¼Œä»¥å¿«é€Ÿæ‰¾åˆ°ç›¸ä¼¼æ–‡æœ¬ã€‚
- ç‰¹æ€§ï¼šæ”¯æŒ25+åµŒå…¥æä¾›å•†å’Œæ–¹æ³•ï¼ŒåŒ…æ‹¬å¼€æºå’Œä¸“æœ‰APIã€‚
- ä¼˜ç‚¹ï¼šæ ‡å‡†æ¥å£ï¼Œæ–¹ä¾¿æ¨¡å‹åˆ‡æ¢ã€‚

   **â‘£ å‘é‡å­˜å‚¨ (Vector Stores)**

- åŠŸèƒ½ï¼šé«˜æ•ˆå­˜å‚¨å’Œæœç´¢æ–‡æ¡£åµŒå…¥ã€‚
- ç‰¹æ€§ï¼šæ”¯æŒ50+å‘é‡å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å¼€æºå’Œäº‘æ‰˜ç®¡é€‰é¡¹ã€‚
- ä¼˜ç‚¹ï¼šæ ‡å‡†æ¥å£ï¼Œè½»æ¾åˆ‡æ¢å­˜å‚¨æ–¹æ¡ˆã€‚

   **â‘¤ æ£€ç´¢å™¨ (Retrievers)**

- åŠŸèƒ½ï¼šä»æ•°æ®åº“ä¸­æ£€ç´¢æ–‡æ¡£ã€‚
- ç‰¹æ€§ï¼šæ”¯æŒå¤šç§æ£€ç´¢ç®—æ³•ï¼ŒåŒ…æ‹¬è¯­ä¹‰æœç´¢å’Œé«˜çº§ç®—æ³•ï¼ˆå¦‚çˆ¶æ–‡æ¡£æ£€ç´¢å™¨ã€è‡ªæŸ¥è¯¢æ£€ç´¢å™¨ã€é›†æˆæ£€ç´¢å™¨ï¼‰ã€‚
- åº”ç”¨ï¼šæé«˜æ£€ç´¢æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚

   **â‘¥ ç´¢å¼• (Indexing)**

- åŠŸèƒ½ï¼šå°†æ•°æ®æºåŒæ­¥åˆ°å‘é‡å­˜å‚¨ï¼Œé¿å…é‡å¤å’Œå†—ä½™ã€‚
- ç‰¹æ€§ï¼šLangChainç´¢å¼•APIï¼Œä¼˜åŒ–å­˜å‚¨å’Œæ£€ç´¢è¿‡ç¨‹ã€‚
- ä¼˜ç‚¹ï¼šèŠ‚çœæ—¶é—´å’Œæˆæœ¬ï¼Œæ”¹å–„æœç´¢ç»“æœè´¨é‡ã€‚

    **ï¼ˆ2ï¼‰æ£€ç´¢ï¼ˆ****Retrieval****ï¼‰å®è·µ**

   åœ¨æœ¬éƒ¨åˆ†ï¼ŒåŸºäºLangChainçš„Retrievalæ¨¡å—å®ç°ä¸€ä¸ªç®€å•çš„â€æœ¬åœ°çŸ¥è¯†åº“é—®ç­”æœºå™¨äººâ€œã€‚

   é¦–å…ˆä»ã€èµ„æ–™ã€‘ä¸­çš„"LangChainå…¥é—¨"ç›®å½•ä¸‹ä¸‹è½½note.txtæ–‡ä»¶å’Œall-MiniLM-L6-v2.zipå‹ç¼©åŒ…ï¼Œé€šè¿‡æ–‡ä»¶ç®¡ç†å°†è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ°/root/Desktop/CM_Chat/langchain_demo/ç›®å½•ä¸‹ã€‚æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è§£å‹all-MiniLM-L6-v2.zipå‹ç¼©åŒ…ï¼Œè¯¥å‹ç¼©åŒ…ä¸­å­˜å‚¨çš„æ˜¯embeddingsæ¨¡å‹ã€‚

```
cd langchain_demo/
unzip all-MiniLM-L6-v2.zip
```

    åœ¨retrieval_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ã€‚
    
    åœ¨æœ¬æ¨¡å—ä¸­ï¼Œä¸»è¦å®ç°äº†ä¸€ä¸ªâ€åŸºäºæœ¬åœ°çŸ¥è¯†åº“çš„å°è¯´æƒ…èŠ‚é—®ç­”æœºå™¨äººâ€œï¼Œä¸»è¦å®ç°æµç¨‹å¦‚ä¸‹ï¼š

- ä½¿ç”¨TextLoader()åŠ è½½"note.txt"æ–‡ä»¶ï¼Œå¹¶è½¬æ¢ä¸ºdocument å¯¹è±¡ï¼Œæ–‡ä»¶å†…å®¹æ¥è‡ªäºã€Šæ–—ç ´è‹ç©¹ã€‹å°è¯´ï¼›
- ä½¿ç”¨CharacterTextSplitter()å°†æ–‡æœ¬æ‹†åˆ†æˆæ–‡æœ¬å—ï¼Œè®¾ç½®ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼šseparatorï¼ˆç”¨äºæŒ‡å®šåˆ†éš”ç¬¦ï¼‰ï¼›chunk_sizeï¼ˆæ¯ä¸ªæ–‡æœ¬å—/æ–‡æ¡£çš„å­—ç¬¦æ•°é‡é™åˆ¶ï¼‰ï¼›chunk_overlapï¼ˆç›¸é‚»ä¸¤ä¸ªæ–‡æ¡£é‡å åŒºåŸŸçš„é•¿åº¦ï¼‰ï¼›
- ä½¿ç”¨SentenceTransformerEmbeddings()åŠ è½½embeddingsæ¨¡å‹ï¼Œé‡‡ç”¨çš„embeddingsæ¨¡å‹all-MiniLM-L6-v2ï¼Œå®ƒå¯ä»¥å°†å¥å­æˆ–è€…æ®µè½æ˜ å°„åˆ°384ç»´çš„å‘é‡ç©ºé—´ä¸­ï¼›
- æ–‡æ¡£å­˜å‚¨å°† documentä½¿ç”¨embeddingsæ¨¡å‹è¿›è¡Œå‘é‡åŒ–å¤„ç†ï¼Œå¹¶ä¸´æ—¶å­˜å…¥ Chroma å‘é‡æ•°æ®åº“ï¼Œç”¨äºåç»­åŒ¹é…æŸ¥è¯¢
- ä½¿ç”¨RetrievalQA()æ ¹æ®é—®é¢˜ä»Chroma å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸ä¼¼åº¦è¾ƒé«˜çš„å†…å®¹ï¼Œå¹¶å°†æ£€ç´¢åˆ°çš„å†…å®¹ç»„åˆæˆä¸Šä¸‹æ–‡ï¼Œä¸åŸå§‹çš„è¾“å…¥ä¸€èµ·å–‚ç»™å¤§æ¨¡å‹ã€‚

```
from langchain.chains import RetrievalQA
from langchain.document_loaders import TextLoader
from langchain.text_splitter import CharacterTextSplitter
from langchain.vectorstores import Chroma
from langchain.chat_models import ChatOpenAI
from langchain.embeddings import SentenceTransformerEmbeddings

openai_api_base = "http://localhost:8000/v1"
openai_api_key = "EMPTY"
model = ChatOpenAI(model_name="Qwen",
                  temperature=0,
                   openai_api_base=openai_api_base,
                   openai_api_key=openai_api_key)


# æ–‡æ¡£åŠ è½½
loader = TextLoader("note.txt")
# å°†æ•°æ®è½¬æˆ document å¯¹è±¡
documents = loader.load()

# æ–‡æœ¬æ‹†åˆ†
text_splitter = CharacterTextSplitter(separator = "\n",chunk_size=300, chunk_overlap=50)
texts = text_splitter.split_documents(documents)

# åˆå§‹åŒ–æœ¬åœ°éƒ¨ç½²çš„ embeddings æ¨¡å‹
embeddings = SentenceTransformerEmbeddings(model_name="all-MiniLM-L6-v2")

# æ–‡æ¡£å­˜å‚¨ï¼šå°† documentä½¿ç”¨embeddingsæ¨¡å‹è¿›è¡Œå‘é‡åŒ–å¤„ç†ï¼Œå¹¶ä¸´æ—¶å­˜å…¥ Chroma å‘é‡æ•°æ®åº“ï¼Œç”¨äºåç»­åŒ¹é…æŸ¥è¯¢
docsearch = Chroma.from_documents(texts, embeddings)
index_count = docsearch._collection.count()
print('æ–‡æ¡£æ•°é‡ï¼š',index_count)
# å…ˆæ£€ç´¢ï¼Œåç”Ÿæˆ
qa = RetrievalQA.from_chain_type(llm=model, chain_type="stuff", retriever=docsearch.as_retriever(search_kwargs={"k": index_count}))

query = "è§ç‚åœ¨æ‹å–åœºäº‰å¤ºçš„æ–—æŠ€å«ä»€ä¹ˆ"
print(qa.run(query))
```

   ä»£ç ç¼–å†™å®Œæ¯•åï¼Œè¿è¡Œretrieval_demo.pyæ–‡ä»¶ï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F5d7086954b0f48458b6e6fc11fc41f04.png)

#### 3.6 **Agents**

   **ï¼ˆ1ï¼‰Agentsçš„æœ¬è´¨åŠä¼˜åŠ¿**

   Agentsçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯åˆ©ç”¨è¯­è¨€æ¨¡å‹æ¥é€‰æ‹©ä¸€ç³»åˆ—è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚ä¸ä¼ ç»Ÿçš„ç¡¬ç¼–ç åŠ¨ä½œé“¾ä¸åŒï¼ŒAgentsä½¿ç”¨è¯­è¨€æ¨¡å‹ä½œä¸ºæ¨ç†å¼•æ“æ¥ç¡®å®šè¦æ‰§è¡Œå“ªäº›åŠ¨ä½œä»¥åŠå®ƒä»¬çš„æ‰§è¡Œé¡ºåºã€‚ä¸»è¦æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **åŸºäºè¯­è¨€æ¨¡å‹çš„å†³ç­–**ï¼šLangChain Agentsä»¥è¯­è¨€æ¨¡å‹ä¸ºæ ¸å¿ƒï¼Œä½¿å…¶èƒ½å¤Ÿç†è§£å’Œæ‰§è¡Œè‡ªç„¶è¯­è¨€æˆ–ç±»ä¼¼è‡ªç„¶è¯­è¨€çš„æŒ‡ä»¤ã€‚è¿™ç§èƒ½åŠ›è®©Agentså¯ä»¥çµæ´»åœ°é€‚åº”ä¸åŒçš„ä»»åŠ¡å’Œç¯å¢ƒï¼Œæ— éœ€ç¡¬ç¼–ç ç‰¹å®šçš„é€»è¾‘ã€‚
- **å¯ç»„åˆæ€§ä¸æ‰©å±•æ€§**ï¼šLangChainæ¡†æ¶æ³¨é‡Agentsçš„å¯ç»„åˆæ€§å’Œç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚Agentså¯ä»¥é€šè¿‡ç»„åˆå„ç§å·¥å…·å’Œæ¨¡å—ï¼ˆå¦‚æ•°æ®æ£€ç´¢ã€ä¿¡æ¯æå–ã€APIè°ƒç”¨ç­‰ï¼‰æ¥æ‰©å±•å…¶åŠŸèƒ½ã€‚è¿™ç§è®¾è®¡æ–¹å¼ä¸ä»…ç®€åŒ–äº†ç»´æŠ¤å’Œæ›´æ–°è¿‡ç¨‹ï¼Œè¿˜ä¿ƒè¿›äº†ä»£ç å’ŒçŸ¥è¯†çš„é‡ç”¨ã€‚
- **å­¦ä¹ ä¸é€‚åº”æ€§**ï¼šç»“åˆæœºå™¨å­¦ä¹ æŠ€æœ¯ï¼ˆå¦‚å¼ºåŒ–å­¦ä¹ ï¼‰ï¼ŒAgentså¯ä»¥ä»ç»éªŒä¸­å­¦ä¹ å¹¶ä¼˜åŒ–å…¶è¡Œä¸ºç­–ç•¥ï¼Œä»¥åº”å¯¹å¤æ‚å’ŒåŠ¨æ€å˜åŒ–çš„ç¯å¢ƒï¼Œä»è€Œæé«˜æ€§èƒ½å’Œæ•ˆç‡ã€‚

   **ï¼ˆ2ï¼‰****Agentsçš„ç»„æˆéƒ¨åˆ†**

   Agentsçš„ç»„æˆéƒ¨åˆ†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240507%2F9d2fc502ee3b41ef8577f88149e5bd0b.png)

- **æ¨¡å¼ï¼ˆSchemaï¼‰ï¼š**æ˜¯ä¸€ç»„è§„åˆ™å’Œç»“æ„ï¼Œå®šä¹‰äº†ä»£ç†å¦‚ä½•ä¸å¤–éƒ¨å·¥å…·è¿›è¡Œäº¤äº’ã€æ‰§è¡ŒåŠ¨ä½œä»¥åŠç®¡ç†ä»»åŠ¡çŠ¶æ€ï¼Œä»è€Œå®ç°æ™ºèƒ½çš„å¤šæ­¥éª¤æ¨ç†å’Œå†³ç­–ã€‚**ä¸»è¦åŒ…æ‹¬AgentActionã€****Intermediate Stepsã€****AgentFinishã€‚**
- **ä»£ç†ï¼ˆAgentï¼‰**: è´Ÿè´£å†³ç­–ä¸‹ä¸€ä¸ªåŠ¨ä½œçš„å®ä½“ã€‚ä»£ç†ä½¿ç”¨è¯­è¨€æ¨¡å‹ã€æç¤ºå’Œè¾“å‡ºè§£æå™¨æ¥æ”¯æŒå…¶å†³ç­–è¿‡ç¨‹ã€‚**ä¸»è¦åŒ…æ‹¬Agent Inputsã€Agent Outputsã€‚**
- **ä»£ç†æ‰§è¡Œå™¨ï¼ˆAgentExecutorï¼‰**: è´Ÿè´£è¿è¡Œä»£ç†å¹¶ç®¡ç†å…¶ä¸å¤–éƒ¨å·¥å…·çš„äº¤äº’ã€‚æ‰§è¡Œå™¨å¤„ç†å¤æ‚æ€§ï¼Œå¦‚å·¥å…·é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ç­‰ã€‚
- **å·¥å…·ï¼ˆToolsï¼‰**: ä»£ç†å¯ä»¥è°ƒç”¨çš„å‡½æ•°æˆ–æœåŠ¡ã€‚æ¯ä¸ªå·¥å…·éƒ½æœ‰ä¸€ä¸ªè¾“å…¥æ¨¡å¼å’Œä¸€ä¸ªå…³è”çš„å‡½æ•°ï¼Œç”¨äºæè¿°å¦‚ä½•è°ƒç”¨è¯¥å·¥å…·ä»¥åŠå®é™…æ‰§è¡Œçš„æ“ä½œã€‚
- **å·¥å…·åŒ…ï¼ˆToolkitsï¼‰**: ç›¸å…³å·¥å…·çš„é›†åˆï¼Œç”¨äºå®Œæˆç‰¹å®šä»»åŠ¡ã€‚ä¾‹å¦‚ï¼ŒGitHub å·¥å…·åŒ…å¯èƒ½åŒ…å«ç”¨äºæœç´¢é—®é¢˜ã€è¯»å–æ–‡ä»¶ã€å‘è¡¨è¯„è®ºç­‰çš„å·¥å…·ã€‚

   **ï¼ˆ3ï¼‰****Agentsæµç¨‹**

   **Agentsæµç¨‹ä¸»è¦åŒ…å«ä»¥ä¸‹å››ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š**

- **æ¥æ”¶ä»»åŠ¡**ï¼šLLM Agenté¦–å…ˆæ¥æ”¶ä¸€ä¸ªä»»åŠ¡æè¿°æˆ–é—®é¢˜ã€‚
- **æ€è€ƒ**ï¼šç„¶åï¼Œå®ƒåˆ©ç”¨LLMè¿›è¡Œæ¨ç†å’Œå†³ç­–ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆæˆ–è¡ŒåŠ¨è®¡åˆ’ã€‚
- **è¡ŒåŠ¨**ï¼šæ¥ä¸‹æ¥ï¼ŒLLM Agentä¼šæ‰§è¡Œä¸€äº›æ“ä½œä»¥å®Œæˆä»»åŠ¡ã€‚è¿™äº›æ“ä½œå¯èƒ½åŒ…æ‹¬è°ƒç”¨APIè·å–æ•°æ®ã€æŸ¥è¯¢æ•°æ®åº“ã€æ‰§è¡Œè®¡ç®—ç­‰ã€‚
- **æ¥æ”¶åé¦ˆ**ï¼šåœ¨æ‰§è¡Œæ“ä½œåï¼ŒLLM Agentä¼šæ¥æ”¶æ¥è‡ªç¯å¢ƒçš„åé¦ˆã€‚è¿™äº›åé¦ˆå¯èƒ½åŒ…æ‹¬APIçš„å“åº”ã€æ•°æ®åº“æŸ¥è¯¢çš„ç»“æœç­‰ã€‚

   å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼ŒLLM Agentä¼šé‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¾¾åˆ°æŸä¸ªç»ˆæ­¢æ¡ä»¶ã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240507%2Fe84f0da54fb242ec9113cb10aa3c869d.png)

   **ï¼ˆ4ï¼‰Agent Types**

   åœ¨LangChainä¸­ï¼ŒAgent Typeså®šä¹‰äº†ä¸åŒç±»å‹çš„ä»£ç†ï¼ˆAgentsï¼‰ï¼Œè¿™äº›ä»£ç†ä½¿ç”¨ä¸åŒçš„ç­–ç•¥å’Œæ–¹æ³•æ¥ä¸ç”¨æˆ·å’Œå·¥å…·è¿›è¡Œäº¤äº’ï¼Œä»¥å®Œæˆå„ç§ä»»åŠ¡ã€‚

- **Zero-shot ReAct**ï¼š
  è¿™ç§Agentä½¿ç”¨ReActï¼ˆRetrieve-and-Actï¼‰æ¡†æ¶ï¼Œè¯¥æ¡†æ¶é€šè¿‡ç†è§£å·¥å…·çš„æè¿°æ¥é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·æ‰§è¡Œä»»åŠ¡ã€‚Zero-shotæ„å‘³ç€Agentä¸éœ€è¦é’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œè®­ç»ƒï¼Œè€Œæ˜¯å¯ä»¥åŸºäºå·¥å…·çš„æè¿°ç›´æ¥è¿›è¡Œæ¨æ–­ã€‚
- **Structured tool chat**ï¼š
  è¿™ç§Agentæ”¯æŒä½¿ç”¨å…·æœ‰å¤æ‚è¾“å…¥å‚æ•°çš„å·¥å…·ã€‚é€šè¿‡å®šä¹‰args_schemaï¼ŒAgentå¯ä»¥ç†è§£æ¯ä¸ªå·¥å…·æ‰€éœ€è¾“å…¥å‚æ•°çš„ç»“æ„å’Œç±»å‹ï¼Œä»è€Œä¸ç”¨æˆ·è¿›è¡Œæ›´ç»“æ„åŒ–çš„å¯¹è¯ä»¥æ”¶é›†å¿…è¦çš„ä¿¡æ¯ã€‚è¿™æœ‰åŠ©äºç¡®ä¿ä¸å·¥å…·çš„äº¤äº’æ˜¯å‡†ç¡®å’Œä¸€è‡´çš„ã€‚
- **Conversational**ï¼š
  ä¸æ ‡å‡†ReAct Agentç›¸æ¯”ï¼ŒConversational Agentæ›´æ³¨é‡ä¸ç”¨æˆ·è¿›è¡Œè‡ªç„¶å¯¹è¯ã€‚å®ƒçš„æç¤ºå’Œå“åº”è®¾è®¡å¾—æ›´åŠ å¯¹è¯æ€§ï¼Œé€‚åˆåœ¨èŠå¤©åœºæ™¯ä¸­ä½¿ç”¨ã€‚
- **Self-ask with search**ï¼š
  è¿™ç§Agentç±»å‹é›†æˆäº†æœç´¢åŠŸèƒ½ï¼Œå…è®¸å®ƒè‡ªä¸»åœ°åœ¨æœç´¢å¼•æ“ä¸­æŸ¥æ‰¾ä¿¡æ¯ä»¥å›ç­”é—®é¢˜ã€‚è¿™å¢åŠ äº†Agentçš„çŸ¥è¯†æ¥æºå’Œå›ç­”é—®é¢˜çš„èƒ½åŠ›ã€‚
- **ReAct document store**ï¼š
  ä½¿ç”¨è¿™ç§Agentï¼Œç”¨æˆ·å¯ä»¥ä¸ä¸€ä¸ªæ–‡æ¡£å­˜å‚¨è¿›è¡Œäº¤äº’ã€‚è¯¥AgentåŒ…å«ä¸¤ä¸ªå…³é”®å·¥å…·ï¼šâ€œSearchâ€ç”¨äºåœ¨æ–‡æ¡£å­˜å‚¨ä¸­æœç´¢ç›¸å…³æ–‡æ¡£ï¼Œâ€œLookupâ€ç”¨äºåœ¨æœ€è¿‘æ‰¾åˆ°çš„æ–‡æ¡£ä¸­æŸ¥æ‰¾ç‰¹å®šæœ¯è¯­æˆ–ä¿¡æ¯ã€‚
- **XML Agent**ï¼š
  XML Agentä¸“é—¨ç”¨äºå¤„ç†XMLæ ¼å¼çš„æ•°æ®ã€‚å®ƒä½¿ç”¨XMLæ ¼å¼æ¥è§£æå·¥å…·è°ƒç”¨å’Œæœ€ç»ˆç­”æ¡ˆï¼Œè¿™ä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆä¸è¿”å›XMLå“åº”çš„å·¥å…·æˆ–æœåŠ¡è¿›è¡Œäº¤äº’ã€‚

   **ï¼ˆ5ï¼‰Agentå®è·µ**

   åœ¨agent_demo.pyæ–‡ä»¶ä¸­ç¼–å†™æœ¬æ¨¡å—çš„ä»£ç ã€‚

   åœ¨æœ¬æ¨¡å—ä¸­ï¼Œå®ç°ä¸€ä¸ªZero-shot ReActç±»å‹çš„Agentï¼Œä¸»è¦å®šä¹‰ä»¥ä¸‹ä¸¤ä¸ªå·¥å…·ï¼š

- calculate()ï¼šä½¿ç”¨LLMMathChainé“¾è®¡ç®—æ•°å­¦å…¬å¼ï¼›
- recommend_meal()ï¼šè°ƒç”¨è¯¥å·¥å…·æ—¶ç›´æ¥è¿”å›â€è‘±çƒ§æµ·å‚â€œå­—ç¬¦ä¸²ã€‚

   æ¥ç€åˆ›å»ºä¸€ä¸ªå·¥å…·åˆ—è¡¨ï¼Œå¹¶æŒ‡æ˜æ¯ä¸ªå·¥å…·çš„åç§°ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„æè¿°ï¼ŒLLMæ¨¡å‹é€šè¿‡ç†è§£æ¯ä¸ªå·¥å…·çš„æè¿°æ¥é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼›æœ€åä½¿ç”¨ initialize_agent()åˆå§‹åŒ–Agentã€‚

```
from langchain.chat_models import ChatOpenAI
from langchain.chains import LLMMathChain
from langchain.agents import initialize_agent, Tool

openai_api_base = "http://localhost:8000/v1"
openai_api_key = "EMPTY"
model = ChatOpenAI(model_name="Qwen",
                  temperature=0,
                   openai_api_base=openai_api_base,
                   openai_api_key=openai_api_key)


# å®šä¹‰è®¡ç®—å™¨è¿‡ç¨‹
def calculate(query: str)->str:
    llm_math = LLMMathChain.from_llm(model, verbose=True)
    ans = llm_math.run(query)
    return ans


# å®šä¹‰é¥­èœæ¨èè¿‡ç¨‹
def recommend_meal(query:str)->str:
    return "è‘±çƒ§æµ·å‚"


# åˆå§‹åŒ–tools
math_tool = Tool(
    name='calculator',
    func=calculate,
    description='è®¡ç®—æ•°å­¦é—®é¢˜æ—¶è¯·ä½¿ç”¨calculatorå·¥å…·'
)
meal_tool = Tool(
    name="recommend_meal",
    func=recommend_meal,
    description="å½“ä½ è¢«è¦æ±‚ä¸ºé¡¾å®¢æ¨èé¥­èœæ—¶è¯·ç”¨è¿™ä¸ªå·¥å…·"
)

tools = [math_tool, meal_tool]

zero_shot_agent = initialize_agent(
    agent="zero-shot-react-description",
    tools=tools,
    llm=model,
    verbose=True,
    max_iterations=3
)

zero_shot_agent("è¯·ä½¿ç”¨calculatorå·¥å…·ï¼Œè®¡ç®—(4.5*2.1)**2.1?")
zero_shot_agent('ä¸­åˆä¸çŸ¥é“åƒä»€ä¹ˆï¼Œè¯·ä¸ºæˆ‘æ¨è')
```

   ä»£ç ç¼–å†™å®Œæ¯•åï¼Œè¿è¡Œagent_demo.pyæ–‡ä»¶ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯¹äºè¾“å…¥â€è¯·ä½¿ç”¨calculatorå·¥å…·ï¼Œè®¡ç®—(4.5*2.1)**2.1?â€œï¼Œè°ƒç”¨calculateå·¥å…·è¿›è¡Œè®¡ç®—å¾—åˆ°ç»“æœâ€111.79098888525806â€œï¼›å¯¹äºè¾“å…¥â€ä¸­åˆä¸çŸ¥é“åƒä»€ä¹ˆï¼Œè¯·ä¸ºæˆ‘æ¨èâ€œï¼Œè°ƒç”¨recommend_mealå·¥å…·è¿”å›èœåâ€è‘±çƒ§æµ·å‚â€œã€‚

![img](https://tecs-prod-static.obs.cn-north-1.myhuaweicloud.com:443/23a1bd42cdb54703b802532f7a361767%2Frichtext%2Fimage%2F20240612%2F2db825adea824d8db22de847c6dd1192.png)

#####  
